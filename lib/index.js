'use strict';var _createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,'value'in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),_axios=require('axios'),_axios2=_interopRequireDefault(_axios),_debug2=require('debug'),_debug3=_interopRequireDefault(_debug2),_eventemitter=require('eventemitter2'),_urlParse=require('url-parse'),_urlParse2=_interopRequireDefault(_urlParse);Object.defineProperty(exports,'__esModule',{value:!0});function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}function _possibleConstructorReturn(a,b){if(!a)throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called');return b&&('object'==typeof b||'function'==typeof b)?b:a}function _inherits(a,b){if('function'!=typeof b&&null!==b)throw new TypeError('Super expression must either be null or a function, not '+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var debug={log:(0,_debug3.default)('superlogin:log'),info:(0,_debug3.default)('superlogin:info'),warn:(0,_debug3.default)('superlogin:warn'),error:(0,_debug3.default)('superlogin:error')},capitalizeFirstLetter=function(a){return a.charAt(0).toUpperCase()+a.slice(1)},parseHostFromUrl=function(a){var b=new _urlParse2.default(a);return b.host},checkEndpoint=function(a,b){var c=parseHostFromUrl(a);return-1<b.findIndex(function(a){return a===c})},isStorageAvailable=function(){var a='__STORAGE__';try{return localStorage.setItem(a,a),localStorage.removeItem(a),!0}catch(a){return!1}},parseError=function(a){return a&&a.response&&a.response.data?a.response.data:a},memoryStorage={setItem:function setItem(a,b){memoryStorage.storage.set(a,b)},getItem:function getItem(a){var b=memoryStorage.storage.get(a);return'undefined'==typeof b?null:b},removeItem:function removeItem(a){memoryStorage.storage.delete(a)},storage:new Map},Superlogin=function(a){function b(){_classCallCheck(this,b);var a=_possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a._oauthComplete=!1,a._config={},a._refreshInProgress=!1,a._http=_axios2.default.create(),a}var c=Math.abs;return _inherits(b,a),_createClass(b,[{key:'configure',value:function configure(){var a=this,b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(b.serverUrl&&(this._http=_axios2.default.create({baseURL:b.serverUrl,timeout:b.timeout})),b.baseUrl=b.baseUrl||'/auth',b.baseUrl=b.baseUrl.replace(/\/$/,''),b.socialUrl=b.socialUrl||b.baseUrl,b.socialUrl=b.socialUrl.replace(/\/$/,''),b.local=b.local||{},b.local.usernameField=b.local.usernameField||'username',b.local.passwordField=b.local.passwordField||'password',b.endpoints&&b.endpoints instanceof Array||(b.endpoints=[]),!b.noDefaultEndpoint){var c=window.location.host;b.serverUrl&&(c=parseHostFromUrl(b.serverUrl)),b.endpoints.push(c)}b.providers=b.providers||[],b.timeout=b.timeout||0,this.storage=isStorageAvailable()?'session'===b.storage?window.sessionStorage:window.localStorage:memoryStorage,this._config=b,this._session=JSON.parse(this.storage.getItem('superlogin.session')),this._httpInterceptor(),b.checkExpired&&(this.checkExpired(),this.validateSession().then(function(){a._onLogin(a._session)}).catch(function(){}))}},{key:'_httpInterceptor',value:function _httpInterceptor(){var a=this;this._http.interceptors.request.eject(this._httpRequestInterceptor),this._http.interceptors.response.eject(this._httpResponseInterceptor),this._httpRequestInterceptor=this._http.interceptors.request.use(function request(b){var c=a.getConfig(),d=a.getSession();return d&&d.token?b.skipRefresh?Promise.resolve(b):a.checkRefresh().then(function(){return checkEndpoint(b.url,c.endpoints)&&(b.headers.Authorization='Bearer '+d.token+':'+d.password),b}):Promise.resolve(b)}.bind(this)),this._httpResponseInterceptor=this._http.interceptors.response.use(null,function responseError(b){var c=a.getConfig();return b&&b.config?(checkEndpoint(b.config.url,c.endpoints)&&b.response&&401===b.response.status&&a.authenticated()&&(debug.warn('Not authorized'),a._onLogout('Session expired')),Promise.reject(b)):Promise.reject(b)}.bind(this))}},{key:'authenticated',value:function authenticated(){return!!(this._session&&this._session.user_id)}},{key:'getConfig',value:function getConfig(){return this._config}},{key:'validateSession',value:function validateSession(){var a=this;return this.authenticated()?this._http.get(this._config.baseUrl+'/session').catch(function(b){throw a._onLogout('Session expired'),parseError(b)}):Promise.reject()}},{key:'getSession',value:function getSession(){return this._session||(this._session=JSON.parse(this.storage.getItem('superlogin.session'))),this._session?Object.assign(this._session):null}},{key:'setSession',value:function setSession(a){this._session=a,this.storage.setItem('superlogin.session',JSON.stringify(this._session)),debug.info('New session set')}},{key:'deleteSession',value:function deleteSession(){this.storage.removeItem('superlogin.session'),this._session=null}},{key:'getDbUrl',value:function getDbUrl(a){return this._session.userDBs&&this._session.userDBs[a]?this._session.userDBs[a]:null}},{key:'getHttp',value:function getHttp(){return this._http}},{key:'confirmRole',value:function confirmRole(a){return this._session&&this._session.roles&&this._session.roles.length&&-1!==this._session.roles.indexOf(a)}},{key:'confirmAnyRole',value:function confirmAnyRole(a){if(!this._session||!this._session.roles||!this._session.roles.length)return!1;for(var b=0;b<a.length;b+=1)if(-1!==this._session.roles.indexOf(a[b]))return!0;return!1}},{key:'confirmAllRoles',value:function confirmAllRoles(a){if(!this._session||!this._session.roles||!this._session.roles.length)return!1;for(var b=0;b<a.length;b+=1)if(-1===this._session.roles.indexOf(a[b]))return!1;return!0}},{key:'checkRefresh',value:function checkRefresh(){if(this._refreshInProgress)return Promise.resolve();if(!this._session||!this._session.user_id)return Promise.reject();var a=this._session.refreshed||this._session.issued,b=this._session.expires,d=void 0===this._config.refreshThreshold?0.5:this._config.refreshThreshold,e=this._session.serverTimeDiff||0;5e3>c(e)&&(e=0);var f=Date.now()+e;return(f-a)/(b-a)>d?(debug.info('Refreshing session'),this.refresh().then(function(a){return debug.log('Refreshing session sucess',a),a}).catch(function(a){throw debug.error('Refreshing session failed',a),a})):Promise.resolve()}},{key:'checkExpired',value:function checkExpired(){if(this.authenticated()){var a=this._session.expires,b=this._session.serverTimeDiff||0;5e3>c(b)&&(b=0);var d=Date.now()+b;d>a&&this._onLogout('Session expired')}}},{key:'refresh',value:function refresh(){var a=this,b=this.getSession();return this._refreshInProgress=!0,this._http.post(this._config.baseUrl+'/refresh',{}).then(function(c){return a._refreshInProgress=!1,c.data.token&&c.data.expires&&(Object.assign(b,c.data),a.setSession(b),a._onRefresh(b)),b}).catch(function(b){throw a._refreshInProgress=!1,parseError(b)})}},{key:'authenticate',value:function authenticate(){var a=this;return new Promise(function(b){var c=a.getSession();c?b(c):a.on('login',function(a){b(a)})})}},{key:'login',value:function login(a){var b=this,c=this._config.local,d=c.usernameField,e=c.passwordField;return a[d]&&a[e]?this._http.post(this._config.baseUrl+'/login',a,{skipRefresh:!0}).then(function(a){return a.data.serverTimeDiff=a.data.issued-Date.now(),b.setSession(a.data),b._onLogin(a.data),a.data}).catch(function(a){throw b.deleteSession(),parseError(a)}):Promise.reject({error:'Username or Password missing...'})}},{key:'register',value:function register(a){var b=this;return this._http.post(this._config.baseUrl+'/register',a,{skipRefresh:!0}).then(function(c){return c.data.user_id&&c.data.token&&(c.data.serverTimeDiff=c.data.issued-Date.now(),b.setSession(c.data),b._onLogin(c.data)),b._onRegister(a),c.data}).catch(function(a){throw parseError(a)})}},{key:'logout',value:function logout(a){var b=this;return this._http.post(this._config.baseUrl+'/logout',{}).then(function(c){return b._onLogout(a||'Logged out'),c.data}).catch(function(c){if(b._onLogout(a||'Logged out'),!c.response||401!==c.response.data.status)throw parseError(c)})}},{key:'logoutAll',value:function logoutAll(a){var b=this;return this._http.post(this._config.baseUrl+'/logout-all',{}).then(function(c){return b._onLogout(a||'Logged out'),c.data}).catch(function(c){if(b._onLogout(a||'Logged out'),!c.response||401!==c.response.data.status)throw parseError(c)})}},{key:'logoutOthers',value:function logoutOthers(){return this._http.post(this._config.baseUrl+'/logout-others',{}).then(function(a){return a.data}).catch(function(a){throw parseError(a)})}},{key:'socialAuth',value:function socialAuth(a){var b=this._config.providers;if(-1===b.indexOf(a))return Promise.reject({error:'Provider '+a+' not supported.'});var c=this._config.socialUrl+'/'+a;return this._oAuthPopup(c,{windowTitle:'Login with '+capitalizeFirstLetter(a)})}},{key:'tokenSocialAuth',value:function tokenSocialAuth(a,b){var c=this,d=this._config.providers;return-1===d.indexOf(a)?Promise.reject({error:'Provider '+a+' not supported.'}):this._http.post(this._config.baseUrl+'/'+a+'/token',{access_token:b}).then(function(a){return a.data.user_id&&a.data.token&&(a.data.serverTimeDiff=a.data.issued-Date.now(),c.setSession(a.data),c._onLogin(a.data)),a.data}).catch(function(a){throw parseError(a)})}},{key:'tokenLink',value:function tokenLink(a,b){var c=this._config.providers;if(-1===c.indexOf(a))return Promise.reject({error:'Provider '+a+' not supported.'});var d=this._config.baseUrl+'/link/'+a+'/token';return this._http.post(d,{access_token:b}).then(function(a){return a.data}).catch(function(a){throw parseError(a)})}},{key:'link',value:function link(a){var b=this._config.providers;if(-1===b.indexOf(a))return Promise.reject({error:'Provider '+a+' not supported.'});if(this.authenticated()){var c=this.getSession(),d='bearer_token='+c.token+':'+c.password,e=this._config.socialUrl+'/link/'+a+'?'+d,f='Link your account to '+capitalizeFirstLetter(a);return this._oAuthPopup(e,{windowTitle:f})}return Promise.reject({error:'Authentication required'})}},{key:'unlink',value:function unlink(a){var b=this._config.providers;return-1===b.indexOf(a)?Promise.reject({error:'Provider '+a+' not supported.'}):this.authenticated()?this._http.post(this._config.baseUrl+'/unlink/'+a).then(function(a){return a.data}).catch(function(a){throw parseError(a)}):Promise.reject({error:'Authentication required'})}},{key:'confirmEmail',value:function confirmEmail(a){return a&&'string'==typeof a?this._http.get(this._config.baseUrl+'/confirm-email/'+a).then(function(a){return a.data}).catch(function(a){throw parseError(a)}):Promise.reject({error:'Invalid token'})}},{key:'forgotPassword',value:function forgotPassword(a){return this._http.post(this._config.baseUrl+'/forgot-password',{email:a},{skipRefresh:!0}).then(function(a){return a.data}).catch(function(a){throw parseError(a)})}},{key:'resetPassword',value:function resetPassword(a){var b=this;return this._http.post(this._config.baseUrl+'/password-reset',a,{skipRefresh:!0}).then(function(a){return a.data.user_id&&a.data.token&&(b.setSession(a.data),b._onLogin(a.data)),a.data}).catch(function(a){throw parseError(a)})}},{key:'changePassword',value:function changePassword(a){return this.authenticated()?this._http.post(this._config.baseUrl+'/password-change',a).then(function(a){return a.data}).catch(function(a){throw parseError(a)}):Promise.reject({error:'Authentication required'})}},{key:'changeEmail',value:function changeEmail(a){return this.authenticated()?this._http.post(this._config.baseUrl+'/change-email',{newEmail:a}).then(function(a){return a.data}).catch(function(a){throw parseError(a)}):Promise.reject({error:'Authentication required'})}},{key:'validateUsername',value:function validateUsername(a){return this._http.get(this._config.baseUrl+'/validate-username/'+encodeURIComponent(a)).then(function(){return!0}).catch(function(a){throw parseError(a)})}},{key:'validateEmail',value:function validateEmail(a){return this._http.get(this._config.baseUrl+'/validate-email/'+encodeURIComponent(a)).then(function(){return!0}).catch(function(a){throw parseError(a)})}},{key:'_oAuthPopup',value:function _oAuthPopup(a,b){var c=this;return new Promise(function(d,e){c._oauthComplete=!1,b.windowName=b.windowTitle||'Social Login',b.windowOptions=b.windowOptions||'location=0,status=0,width=800,height=600';var f=window.open(a,b.windowName,b.windowOptions);if(!f)return e({error:'Authorization popup blocked'});var g=setInterval(function(){return f?f.closed&&(clearInterval(g),!c._oauthComplete)?(c.authComplete=!0,e({error:'Authorization cancelled'})):void 0:(clearInterval(g),c._oauthComplete?void 0:(c.authComplete=!0,e({error:'Authorization failed'})))},500),h=function(a){var b=a.data,f=b.error,g=b.session,i=b.link,j=b.type;return'oauthSession'===j?(window.removeEventListener('message',h),!f&&g)?(g.serverTimeDiff=g.issued-Date.now(),c.setSession(g),c._onLogin(g),d(g)):!f&&i?(c._onLink(i),d(capitalizeFirstLetter(i)+' successfully linked.')):(c._oauthComplete=!0,e(f)):void 0};return window.addEventListener('message',h)})}},{key:'_onLogin',value:function _onLogin(a){debug.info('Login',a),this.emit('login',a)}},{key:'_onLogout',value:function _onLogout(a){this.deleteSession(),debug.info('Logout',a),this.emit('logout',a)}},{key:'_onLink',value:function _onLink(a){debug.info('Link',a),this.emit('link',a)}},{key:'_onRegister',value:function _onRegister(a){debug.info('Register',a),this.emit('register',a)}},{key:'_onRefresh',value:function _onRefresh(a){debug.info('Refresh',a),this.emit('refresh',a)}}]),b}(_eventemitter.EventEmitter2);exports.default=new Superlogin;